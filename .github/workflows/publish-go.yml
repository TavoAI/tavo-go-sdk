name: Publish Go SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
  repository_dispatch:
    types: [publish]

jobs:
  publish:
    name: Publish to Go Module Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Create source archive
        run: |
          # Create source code archive immediately after setup, before any file modifications
          # Strip 'v' prefix if present for filename
          RAW_VERSION="${{ inputs.version || github.event.client_payload.version }}"
          VERSION=${RAW_VERSION#v}
          # Create archive in /tmp to avoid including it in itself
          # Exclude .git directory and other files that might change during build
          tar -czf /tmp/tavo-go-sdk-v${VERSION}-source.tar.gz --exclude='.git' --exclude='*.log' --exclude='tmp' --exclude='.DS_Store' .

      - name: Update version
        run: |
          # Strip 'v' prefix if present and update version in go.mod
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          # Go modules use semantic versioning, so we need to ensure the version is valid
          # The version should already be in the correct format from the release workflow

      - name: Tidy dependencies
        run: |
          go mod tidy

      - name: Run tests
        run: |
          go test ./...

      - name: Build package
        run: |
          go build ./...

      - name: Build package
        run: |
          go build ./...

      - name: Create Git tag for Go module
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Create and push the version tag
          TAG_NAME="v${{ env.VERSION }}"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Create GitHub release with source archive
        run: |
          # Create a release in the Go SDK repository with the source archive
          gh release create v${{ env.VERSION }} /tmp/tavo-go-sdk-v${{ env.VERSION }}-source.tar.gz \
            --title "Go SDK v${{ env.VERSION }}" \
            --notes "Automated release of Go SDK v${{ env.VERSION }}"
          # Upload the source archive to the GitHub release in the main repo
          gh release upload v${{ env.VERSION }} /tmp/tavo-go-sdk-v${{ env.VERSION }}-source.tar.gz --clobber --repo TavoAI/tavo-sdk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        run: |
          echo "âœ… Go SDK v${{ env.VERSION }} published successfully!"
          echo "ðŸ“¦ Go module available at: https://pkg.go.dev/github.com/TavoAI/tavo-go-sdk@v${{ env.VERSION }}"
