name: Publish Go SDK

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
  repository_dispatch:
    types: [publish]

jobs:
  publish:
    name: Publish to Go Module Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Create source archive
        run: |
          # Create source code archive immediately after setup, before any file modifications
          # Strip 'v' prefix if present for filename
          RAW_VERSION="${{ inputs.version || github.event.client_payload.version }}"
          VERSION=${RAW_VERSION#v}
          # Create archive in /tmp to avoid including it in itself
          # Exclude .git directory and other files that might change during build
          tar -czf /tmp/tavo-go-sdk-v${VERSION}-source.tar.gz --exclude='.git' --exclude='*.log' --exclude='tmp' --exclude='.DS_Store' .

      - name: Update version
        run: |
          # Strip 'v' prefix if present and update version in go.mod
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          # Go modules use semantic versioning, so we need to ensure the version is valid
          # The version should already be in the correct format from the release workflow

      - name: Tidy dependencies
        run: |
          go mod tidy

      - name: Run tests
        run: |
          go test ./...

      - name: Build package
        run: |
          go build ./...

      - name: Build package
        run: |
          go build ./...

      - name: Create Git tag for Go module
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Create and push the version tag
          TAG_NAME="v${{ env.VERSION }}"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Upload source archive to release
        run: |
          # Wait for the release to be created and then upload the source archive
          # Retry up to 10 times with 30 second delays
          for i in {1..10}; do
            if gh release view v${{ env.VERSION }} --repo TavoAI/tavo-api >/dev/null 2>&1; then
              echo "Release found, uploading source archive..."
              gh release upload v${{ env.VERSION }} /tmp/tavo-go-sdk-v${{ env.VERSION }}-source.tar.gz --clobber --repo TavoAI/tavo-api
              break
            else
              echo "Release not found yet, waiting 30 seconds... (attempt $i/10)"
              sleep 30
            fi
          done
          if [ $i -eq 10 ]; then
            echo "‚ùå Release still not found after 10 attempts"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        run: |
          echo "‚úÖ Go SDK v${{ env.VERSION }} published successfully!"
          echo "üì¶ Go module available at: https://pkg.go.dev/github.com/TavoAI/tavo-go-sdk@v${{ env.VERSION }}"
